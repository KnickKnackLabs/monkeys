#!/usr/bin/env bash
#MISE description="Transcribe speech from an audio file"
#USAGE arg "[file]" help="Audio file to transcribe (WAV)"
#USAGE flag "-o --output <file>" help="Save transcription to file (default: print to stdout)"
#USAGE flag "--model <model>" help="Whisper model to use (e.g. tiny.en, base.en, small.en)" default="base.en"
#USAGE flag "--no-cache" help="Skip cache (force re-transcription)"
#USAGE flag "--record" help="Record from microphone before transcribing"
#USAGE flag "-d --duration <seconds>" help="Recording duration in seconds (with --record)"

set -e

FILE="${usage_file}"
OUTPUT="${usage_output}"
MODEL="${usage_model}"
NO_CACHE="${usage_no_cache:-false}"
RECORD="${usage_record:-false}"
DURATION="${usage_duration}"
CALLER_DIR="${MONKEYS_CALLER_PWD:-$(pwd)}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Record from microphone if --record flag is set
if [[ "$RECORD" == "true" ]]; then
    RECORD_TMPDIR=$(mktemp -d /tmp/monkeys-record-XXXXXX)
    RECORD_FILE="${RECORD_TMPDIR}/recording.wav"
    RECORD_ARGS=("$RECORD_FILE")
    if [[ -n "$DURATION" ]]; then
        RECORD_ARGS+=(-d "$DURATION")
    fi
    mise run record "${RECORD_ARGS[@]}"
    FILE="$RECORD_FILE"
elif [[ -z "$FILE" ]]; then
    if [[ -t 0 ]]; then
        echo "Error: Provide an audio file, use --record, or pipe audio to stdin" >&2
        exit 1
    fi
    # Read audio from stdin to temp file
    STDIN_TMPDIR=$(mktemp -d /tmp/monkeys-stdin-XXXXXX)
    STDIN_FILE="${STDIN_TMPDIR}/input.wav"
    cat > "$STDIN_FILE"
    if [[ ! -s "$STDIN_FILE" ]]; then
        echo "Error: No audio data received from stdin" >&2
        rm -rf "$STDIN_TMPDIR"
        exit 1
    fi
    FILE="$STDIN_FILE"
else
    # Resolve relative input path to caller's directory
    if [[ "$FILE" != /* ]]; then
        FILE="${CALLER_DIR}/${FILE}"
    fi

    # Validate input file exists
    if [[ ! -f "$FILE" ]]; then
        echo "Error: File not found: $FILE" >&2
        exit 1
    fi
fi

# Resolve relative output path if specified
if [[ -n "$OUTPUT" && "$OUTPUT" != /* ]]; then
    OUTPUT="${CALLER_DIR}/${OUTPUT}"
fi

# Check for ffmpeg (needed for resampling)
if ! command -v ffmpeg &>/dev/null; then
    echo "Error: ffmpeg is required for audio resampling." >&2
    echo "  Install: brew install ffmpeg (macOS) or apt install ffmpeg (Linux)" >&2
    exit 1
fi

# Model cache directory
MODEL_DIR="${HOME}/.cache/monkeys/whisper"
mkdir -p "$MODEL_DIR"

# Resample to 16kHz WAV (whisper requirement)
LISTEN_TMPDIR=$(mktemp -d /tmp/monkeys-listen-XXXXXX)
TMPFILE="${LISTEN_TMPDIR}/resampled.wav"
trap 'rm -rf "$LISTEN_TMPDIR" "${RECORD_TMPDIR:-}" "${STDIN_TMPDIR:-}"' EXIT
ffmpeg -i "$FILE" -ar 16000 -ac 1 -y "$TMPFILE" 2>/dev/null

# Transcription cache
TRANSCRIPT_CACHE_DIR="${HOME}/.cache/monkeys/transcripts"
FILE_HASH=$(shasum -a 256 "$TMPFILE" | cut -d' ' -f1)
CACHE_FILE="${TRANSCRIPT_CACHE_DIR}/${FILE_HASH}-${MODEL}.txt"

# Check cache
if [[ "$NO_CACHE" != "true" && -f "$CACHE_FILE" ]]; then
    TRANSCRIPTION=$(cat "$CACHE_FILE")
    echo "(cached)" >&2
else
    echo "Transcribing..." >&2
    echo "  Input: $FILE" >&2
    echo "  Model: $MODEL" >&2

    TRANSCRIPTION=$(uv run "$REPO_DIR/scripts/listen.py" \
        --input "$TMPFILE" \
        --model "$MODEL" \
        --models-dir "$MODEL_DIR" 2>/dev/null)

    echo "  Done!" >&2

    # Store in cache
    if [[ "$NO_CACHE" != "true" ]]; then
        mkdir -p "$TRANSCRIPT_CACHE_DIR"
        echo "$TRANSCRIPTION" > "$CACHE_FILE"
    fi
fi

# Output transcription
if [[ -n "$OUTPUT" ]]; then
    echo "$TRANSCRIPTION" > "$OUTPUT"
    echo "Transcription saved to $OUTPUT" >&2
else
    echo "$TRANSCRIPTION"
fi
